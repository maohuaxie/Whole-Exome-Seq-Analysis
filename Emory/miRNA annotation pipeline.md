SOP for miRNA annotation
========================

# This is a pipeline for miRNA annotation

## Software requirement for this annotation pipeline

* Trimmomatic v0.36
* Anaconda2/4.2.0 
* SHRiMP v2.2.3  
* R v3.4.3 

### Resources

SHRiMP is a software package for aligning genomic reads against a target genome. 
It was primarily developed with the multitudinous short reads of next generation sequencing machines in mind, 
as well as Applied Biosystem's colourspace genomic representation. For more infor please check: http://compbio.cs.toronto.edu/shrimp/ and https://github.com/compbio-UofT/shrimp

For remove the adapter, you can find the detailed guideline as below: http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf
with the following link, you will find the mirbase database, after download the mirbase database, you can retrieve the species what you are working on if you want. 

```
wget ftp://mirbase.org/pub/mirbase/CURRENT/hairpin.fa.gz   
wget ftp://mirbase.org/pub/mirbase/CURRENT/mature.fa.zip    
wget ftp://mirbase.org/pub/mirbase/CURRENT/hairpin.fa.zip
wget ftp://mirbase.org/pub/mirbase/CURRENT/genomes/hsa.gff3 
wget ftp://mirbase.org/pub/mirbase/CURRENT/miFam.dat.zip

```
## Generating hairpin.human.fa and mature.human.fa reference file for miRNA annotation with miRbase.sh

We project the database with:
$SHRIMP_FOLDER/utils/project-db.py --seed 00111111001111111100,00111111110011111100,00111111111100111100,00111111111111001100,00111111111111110000 \
--h-flag --shrimp-mode ls /home/mxie/Projects/miRNA/analysis/miRbase1/hairpin.human.fa
$SHRIMP_FOLDER/utils/project-db.py --seed 00111111001111111100,00111111110011111100,00111111111100111100,00111111111111001100,00111111111111110000 \
--h-flag --shrimp-mode ls /home/mxie/Projects/miRNA/analysis/miRbase1/mature.human.fa

Here, we  used 5  seeds of weight 14 and span 20 which  allow for  2 initial
mismatches (the leading 00), followed by a match of length 7bp (the 6 following
1s), followed by another match of various forms.

Note:  The seeds  are  applied to  the color space  translations of both  the
database and the  reads. Hence, a  string of 6  consecutive 1s corresponds  to 6
consecutive matching colours, which are in particular generated by a string of 7
consecutive matching letters.
### miRbase.sh
```
#!/bin/sh
set -euo pipefail
wget ftp://mirbase.org/pub/mirbase/CURRENT/hairpin.fa.gz   
wget ftp://mirbase.org/pub/mirbase/CURRENT/mature.fa.zip    
wget ftp://mirbase.org/pub/mirbase/CURRENT/hairpin.fa.zip
wget ftp://mirbase.org/pub/mirbase/CURRENT/genomes/hsa.gff3 
wget ftp://mirbase.org/pub/mirbase/CURRENT/miFam.dat.zip
gunzip hairpin.fa.gz
unzip mature.fa.zip
grep sapiens mature.fa |wc   # 2588 
grep sapiens hairpin.fa |wc  # 1881 
# Homo sapiens
perl -alne '{if(/^>/){if(/Homo/){$tmp=1}else{$tmp=0}};next if $tmp!=1;s/U/T/g if !/>/;print }' hairpin.fa >hairpin.human.fa
perl -alne '{if(/^>/){if(/Homo/){$tmp=1}else{$tmp=0}};next if $tmp!=1;s/U/T/g if !/>/;print }' mature.fa >mature.human.fa
cd /sw/hgcc/Pkgs/SHRiMP/2.2.3
export SHRIMP_FOLDER=$PWD
cd /home/mxie/Projects/miRNA/src/miRbase
$SHRIMP_FOLDER/utils/project-db.py --seed 00111111001111111100,00111111110011111100,00111111111100111100,00111111111111001100,00111111111111110000  --h-flag --shrimp-mode ls /home/mxie/Projects/miRNA/src/miRbase/hairpin.human.fa
$SHRIMP_FOLDER/utils/project-db.py --seed 00111111001111111100,00111111110011111100,00111111111100111100,00111111111111001100,00111111111111110000  --h-flag --shrimp-mode ls /home/mxie/Projects/miRNA/src/miRbase/mature.human.fa

```

## Parse file id and merge multiple Fastq files into one big Fastq file
### parseid.py
```
import os
import csv
os.chdir("/home/mxie/Projects/miRNA/data/Past86samples")
filelist=[]
for f in os.listdir():
    f_name,f_ext = os.path.splitext(f)
    f1 = f_name.split('_')[0]
    f2 = f_name.split('_')[1]
    f3 = f_name.split('_')[2]
    newname= "_".join([f1,f2,f3])
    filelist.append(newname)
cleanlist = []
[cleanlist.append(x) for x in filelist if x not in cleanlist]
with open("/home/mxie/Projects/miRNA/src/cleanlist.csv",'w') as resultFile:
    wr = csv.writer(resultFile, dialect='excel')
    wr.writerow(cleanlist)
with open ("/home/mxie/Projects/miRNA/src/cleanlist.txt","w")as file:
   file.write('\n'.join(cleanlist))
```
### mergefastqfile.sh
```   
#!/bin/sh
set -euo pipefail   
for file in $(cat /home/mxie/Projects/miRNA/src/cleanlist.txt);
do
zcat $file* | pigz > /home/mxie/Projects/miRNA/analysis/pastsample/$file.fastq.gz; 
done   
# please copy mergefastqfile.sh to the fastq files folder(eg. /home/mxie/Projects/data/Past86samples) and submit "qsub -cwd -pe smp 24 mergefastqfile.sh" 

```

## Remove the adapter with removeadaptor.sh by using trimmomatic

please note: For each step, if the directory is not specified, bassically, it is in the current directory. You also can check back where the previous output is.
For example:
In previous step, we are in /home/mxie/Projects/miRNA/analysis/pastsample/
The output will be in /home/mxie/Projects/miRNA/analysis/trimmed, before running this step, please make sure you have created the trimmed directory. 
### removeadaptor.sh
``` 
#!/bin/sh
set -euo pipefail
ls *fastq.gz |while read id
do
echo $id
java -Xmx2g -jar /sw/hgcc/Pkgs/Trimmomatic/0.36/trimmomatic-0.36.jar SE -phred33 $id  /home/mxie/Projects/miRNA/analysis/trimmed/${id%%.*}_miRNAtrimmed.fastq.gz ILLUMINACLIP:/home/mxie/Projects/miRNA/src/illumina_RGA_3p_adapter.fa:2:30:10;
done

# please copy removeadaptor.sh to the fastq.gz files folder(eg. /home/mxie/Projects/miRNA/analysis/pastsample) and submit "qsub -cwd -pe smp 24 removeadaptor.sh"

``` 

## Do quality control and show the length distribution with lengthdistribution.sh 

please note: For each step, if the directory is not specified, bassically, it is in the current directory. You also can check back where the previous output is.
For example:
In previous step, we are in /home/mxie/Projects/miRNA/analysis/trimmed.
The output will be in /home/mxie/Projects/miRNA/analysis/QC_readlength, before running this step, please make sure you have created the QC_readlength directory.
### lengthdistribution.sh
```
#!/bin/sh
set -euo pipefail
ls *_miRNAtrimmed.fastq.gz |while read id
do
echo $id
gunzip -c $id | awk '{if(NR%4==2) print length($1)}' | sort -n | uniq -c >/home/mxie/Projects/miRNA/analysis/QC_readlength/${id%%.*}_length.txt;
done
# please copy lengthdistribution.sh to /home/mxie/Projects/miRNA/analysis/trimmed folder and "qsub -cwd -pe smp 24 lengthdistribution.sh"
```
### merge the trimmedlength distribution table and ggplot the trimmedlength distribution
Please note: you may need change setwd("D:/Emoryjob/miRNA/trimmedlength/") to your personal directory

```
rm(list=ls())
setwd("D:/Emoryjob/miRNA/trimmedlength/")

library(dplyr)
allFiles=list.files()
i=allFiles[1]
#sampleID=strsplit(i,"_")[[1]][1]
sampleID=substring(i,1,7)
dat=read.table(i,stringsAsFactors = F)
colnames(dat)=c(sampleID,'Readlength')
for (i in allFiles[-1]){
  #sampleID=strsplit(i,"_")[[1]][1]
  sampleID=substring(i,1,7)
  a=read.table(i,stringsAsFactors = F)
  colnames(a)=c(sampleID,'Readlength')
  dat=merge(dat,a,by='Readlength')
}
write.table (dat, "Readlengthtable.txt", col.names=TRUE,row.names=F,sep="\t",quote=FALSE)

setwd("D:/Emoryjob/miRNA/trimmedlength/")
lenData <- read.table("Readlengthtable.txt",sep ='',header = T, check.names=F)

lenData2=as.data.frame(lenData[,1])
lenData1=as.data.frame(lenData[,1])
colnames(lenData2)=c('Readlength')
colnames(lenData1)=c('Readlength')
for (i in 2:length(lenData[1,])){
   if (which.max (lenData[,i]) !=22 | max(lenData[,i]) < 5000000){
      lenDataT = as.data.frame(lenData[,i])
      colnames(lenDataT)=colnames(lenData)[i]
      lenData2=as.data.frame(cbind(lenData2,lenDataT))
      print(colnames(lenData)[i])
      
   }else{
     lenDataTT = as.data.frame(lenData[,i])
     colnames(lenDataTT)=colnames(lenData)[i]
     lenData1=as.data.frame(cbind(lenData1,lenDataTT))
   }
  
   }

library("reshape2")
library("ggplot2")

lenData1=melt(lenData1, id="Readlength")
lenData2=melt(lenData2, id="Readlength")
p<-ggplot(data=lenData1,
          aes(x=Readlength, y=value, fill= variable)) +
  geom_line(color="blue")
p<-p +  geom_line(data=lenData2,aes(x=Readlength, y=value),color="Red")
print(p)

```

## Mapping miRNA to miRbase reference with mapping.sh

We mapped the reads with:

$SHRIMP_FOLDER/bin/gmapper-ls --strata -o 1 --qv-offset 33 -Q -L /home/mxie/Projects/miRNA/src/mature.human-ls $id \
-N 14 --mode mirna -w 170% -E --un ${id}_unmapped-miRNA.fastq \
>${id%%.*}_mapping.sam 2>${id%%.*}_maping.log;

The options used above have the following meaning:
-L /home/mxie/Projects/miRNA/analysis/miRbase/mature.human-ls : Load genome projection.
-N 14 : Use 14 threads of control.
-w 170% : Enlarge the length  of the genome window against  which each read is being mapped.
"--mode mirna" is equivalent with:
loading the 5 seeds mentioned above; plus
"-H -n 1 -w 100% -U -a 0 -g -255 -q -255 -Z"  
[ -E/--sam ]
Select SAM output format. (This is on by default as of v2.3.0.)

If you want to more detailed information, please check out with: https://github.com/compbio-UofT/shrimp
### mapping.sh
```
#!/bin/sh
set -euo pipefail
cd /sw/hgcc/Pkgs/SHRiMP/2.2.3
export SHRIMP_FOLDER=$PWD
cd /home/mxie/Projects/miRNA/data/trimmed
ls *miRNAtrimmed.fastq.gz |while read id
do
echo $id
$SHRIMP_FOLDER/bin/gmapper-ls --strata -o 1 --qv-offset 33 -Q -L /home/mxie/Projects/miRNA/src/miRbase/mature.human-ls $id \
-N 14 --mode mirna -w 170% -E --un /home/mxie/Projects/miRNA/analysis/unmapped/${id}_unmapped-miRNA.fastq \
 >/home/mxie/Projects/miRNA/analysis/mapped/${id%%.*}_mapping.sam 2>/home/mxie/Projects/miRNA/analysis/mapped/${id%%.*}_maping.log;
done

# please copy mapping.sh to /home/mxie/Projects/miRNA/analysis/trimmed folder and submit "qsub -cwd -pe smp 24 mapping.sh"

```

## Counting the mapped reads

The idea behind here is to count the raw number for each miRNA, sum up the raw number for each miRNA with for loop in perl and save the sum up number into file
please note: For each step, if the directory is not specified, bassically, it is in the current directory. 
Before Couting, we need contvert sam files to bam files, sort and index them. 

### samtobamsort.sh
```
#!/bin/sh
set -euo pipefail
ls  *.sam| while read id
do
echo $id
file="${id:0:12}"
/sw/hgcc/Pkgs/samtools/1.5/bin/samtools view -Su $id > /home/mxie/Projects/miRNA/analysis/mapped/${file}_miRNAtrimmed_mapping.bam;
/sw/hgcc/Pkgs/samtools/1.5/bin/samtools sort /home/mxie/Projects/miRNA/analysis/mapped/${file}_miRNAtrimmed_mapping.bam > /home/mxie/Projects/miRNA/analysis/mapped/${file}_miRNAtrimmed_to_MB_mt_sorted.bam
/sw/hgcc/Pkgs/samtools/1.5/bin/samtools index /home/mxie/Projects/miRNA/analysis/mapped/${file}_miRNAtrimmed_to_MB_mt_sorted.bam
done

# please copy samtobamsort.sh to /home/mxie/Projects/miRNA/analysis/mapped folder and submit "qsub -cwd -pe smp 24 samtobamsort.sh"

```
### counting.sh
```
#!/bin/sh
set -euo pipefail
for tbf in *_miRNAtrimmed_to_MB_mt_sorted.bam; 
do sid=${tbf%%_miRNAtrimmed_to_MB_mt_sorted.bam}; 

if [ ! -e /home/mxie/Projects/miRNA/analysis/counted/${sid}_mt_subcount.txt ]; 
then echo /home/mxie/Projects/miRNA/analysis/counted/${sid}_mt_subcount.txt; 
for mirna in `/sw/hgcc/Pkgs/samtools/1.5/bin/samtools view -h ${tbf} | gawk '$1 == "@SQ"{printf("%s\n",substr($2,4))}' | sort`; do cnt=`/sw/hgcc/Pkgs/samtools/1.5/bin/samtools view -c ${tbf} ${mirna}`; echo "${mirna}	${cnt}"; 
done > /home/mxie/Projects/miRNA/analysis/counted/${sid}_mt_subcount.txt; fi; done

# please copy counting.sh to /home/mxie/Projects/miRNA/analysis/mapped folder and submit "counting.sh"

```

## Do mapped lenght quality control and show the mapped length distribution

The idea behind here is to calculate the num of mapped reads with different length and make plot to show the distribution of mapped reads
### mappinglenthdistribution.sh
```
#!/bin/sh
set -euo pipefail
ls  *.sam| while read id
do
echo $id
file="${id:0:12}"
/sw/hgcc/Pkgs/samtools/1.5/bin/samtools view $id | gawk '{mlarr[length($10)]++}END{for (len = 1; len <=101; len++) printf("%d\t%d\n",len,mlarr[len])}' | sort -k 1n,1n  > /home/mxie/Projects/miRNA/analysis/QC_mappedlength/${file}_mapped_length_distribution_data.txt
done

# please copy mappinglenthdistribution.sh to /home/mxie/Projects/miRNA/analysis/mapped folder and submit "mappinglenthdistribution.sh"

```
Please note: you may need change setwd("D:/Emoryjob/miRNA/mappedlength/") to your personal directory. The following R code will merege each sample's mappedlength files into one file and ggplot the mappep lengh distritution. 

```
rm(list=ls())
setwd("D:/Emoryjob/miRNA/mappedlength/")
library(dplyr)
allFiles=list.files()
i=allFiles[1]
#sampleID=strsplit(i,"_")[[1]][1]
sampleID=substring(i,1,7)
dat=read.table(i,stringsAsFactors = F)
colnames(dat)=c('Mappedlength',sampleID)
for (i in allFiles[-1]){
  #sampleID=strsplit(i,"_")[[1]][1]
  sampleID=substring(i,1,7)
  a=read.table(i,stringsAsFactors = F)
  colnames(a)=c('Mappedlength',sampleID)
  dat=merge(dat,a,by='Mappedlength')
}

write.table (dat, "Mappedlength.txt", col.names=TRUE,row.names=F,sep="\t",quote=FALSE)

setwd("D:/Emoryjob/miRNA/mappedlength/")
lenData <- read.table("Mappedlength.txt",sep ='',header = T,check.names=F)

lenData2=as.data.frame(lenData[,1])
lenData1=as.data.frame(lenData[,1])
colnames(lenData2)=c('Mappedlength')
colnames(lenData1)=c('Mappedlength')
for (i in 2:length(lenData[1,])){
  if (which.max (lenData[,i]) !=22 | max(lenData[,i]) < 5000000){
    lenDataT = as.data.frame(lenData[,i])
    colnames(lenDataT)=colnames(lenData)[i]
    lenData2=as.data.frame(cbind(lenData2,lenDataT))
    print(colnames(lenData)[i])
    
  }else{
    lenDataTT = as.data.frame(lenData[,i])
    colnames(lenDataTT)=colnames(lenData)[i]
    lenData1=as.data.frame(cbind(lenData1,lenDataTT))
  }
}

library("reshape2")
library("ggplot2")

lenData1=melt(lenData1, id="Mappedlength")
lenData2=melt(lenData2, id="Mappedlength")
p<-ggplot(data=lenData1,
          aes(x=Mappedlength, y=value, fill= variable)) +
  geom_line(color="blue")
p<-p +  geom_line(data=lenData2,aes(x=Mappedlength, y=value),color="Red")
print(p)

```



